{% extends "base.html" %}

{% block title %}Chat{% endblock %}
{% block body_class %}bg-hero{% endblock %}

{% block content %}
<section class="messages-shell">
  <div class="header-row">
    <div>
      <p class="subtitle">ConversaciÃ³n</p>
      <h1 class="headline">Chat</h1>
    </div>
    <p class="text-muted">{{ request.session.user }}</p>
  </div>

  <div class="messages-box" id="messages-box">
    {% for m in mensajes %}
      <div class="msg {% if m.user == current_user_id %}msg--mine{% endif %}">
        <div class="msg__meta">{{ m.user }} Â· {{ m.date }}</div>
        <div class="msg__body">{{ m.texto }}</div>
        {% if m.file %}
          <div class="msg__files">
            {% for file in m.file %}
              <a class="msg__file" href="{{ file }}" target="_blank">Archivo</a>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <form method="POST" class="composer" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="text" name="mensaje" placeholder="Escribe un mensaje..." required autocomplete="off">

    <label class="file-chip" id="file-chip">
      ðŸ“Ž
      <input id="file-input" type="file" name="archivos" multiple>
      <span class="badge" id="file-badge">0</span>
    </label>

    <button type="submit" class="btn btn-primary btn-small">Enviar</button>
  </form>
</section>

<script>
function scrollToBottom() {
  const box = document.getElementById("messages-box");
  if (box) box.scrollTop = box.scrollHeight;
}
scrollToBottom();

async function refreshMessages() {
  try {
    const resp = await fetch(window.location.href, { cache: "no-store" });
    if (!resp.ok) return;
    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const newBox = doc.getElementById("messages-box");
    if (!newBox) return;
    const current = document.getElementById("messages-box");
    const isNearBottom = current.scrollHeight - current.scrollTop - current.clientHeight < 150;
    if (current.innerHTML.trim() === newBox.innerHTML.trim()) return;
    current.innerHTML = newBox.innerHTML;
    if (isNearBottom) scrollToBottom();
  } catch (e) { console.error(e); }
}
setInterval(refreshMessages, 3000);

const fileInput = document.getElementById("file-input");
const chip = document.getElementById("file-chip");
const badge = document.getElementById("file-badge");
fileInput.addEventListener("change", () => {
  const total = fileInput.files.length;
  if (total > 0) {
    chip.classList.add("has-files");
    badge.textContent = total;
  } else {
    chip.classList.remove("has-files");
  }
});
</script>

{% endblock %}
